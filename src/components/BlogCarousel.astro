---
import type { CollectionEntry } from "astro:content";
import FeaturedPost from "@components/FeaturedPost.astro";
import PostGridItem from "@components/PostGridItem.astro";

interface Props {
  posts: CollectionEntry<"blog">[];
}

const { posts } = Astro.props;

// First post is featured, rest are for grid (groups of 3)
const featuredPost = posts[0];
const remainingPosts = posts.slice(1);

// Create groups of 3 posts for the grid slides
const gridSlides: CollectionEntry<"blog">[][] = [];
for (let i = 0; i < remainingPosts.length; i += 3) {
  gridSlides.push(remainingPosts.slice(i, i + 3));
}
---

<div class="carousel-wrapper overflow-hidden relative group w-full">
  <div
    class="flex items-center justify-between mb-8 absolute top-[-80px] right-0 z-10"
  >
    <div class="flex gap-4">
      <button
        class="carousel-button prev w-10 h-10 rounded-full border border-border flex items-center justify-center hover:bg-surface transition-colors disabled:opacity-30 disabled:cursor-not-allowed bg-background"
        aria-label="Post anterior"
      >
        <span class="material-icons-outlined">chevron_left</span>
      </button>
      <button
        class="carousel-button next w-10 h-10 rounded-full border border-border flex items-center justify-center hover:bg-surface transition-colors disabled:opacity-30 disabled:cursor-not-allowed bg-background"
        aria-label="Siguiente post"
      >
        <span class="material-icons-outlined">chevron_right</span>
      </button>
    </div>
  </div>

  <div
    class="carousel-container transition-transform duration-500 ease-in-out flex w-full"
  >
    <!-- Featured Post Slide -->
    <div class="carousel-slide min-w-full w-full flex-shrink-0 px-1">
      {featuredPost && <FeaturedPost post={featuredPost} />}
    </div>

    <!-- Grid Slides -->
    {
      gridSlides.map((slideGroup) => (
        <div class="carousel-slide min-w-full w-full flex-shrink-0 px-1">
          <div class="grid md:grid-cols-3 gap-8">
            {slideGroup.map((post) => (
              <PostGridItem post={post} />
            ))}
          </div>
        </div>
      ))
    }
  </div>
</div>

<script>
  // Use a class to handle multiple carousels if needed, though currently selecting by class
  // scoped to this component's usage context
  function initCarousel(wrapper: Element) {
    const container = wrapper.querySelector(
      ".carousel-container",
    ) as HTMLElement;
    const prevButton = wrapper.querySelector(
      ".carousel-button.prev",
    ) as HTMLButtonElement;
    const nextButton = wrapper.querySelector(
      ".carousel-button.next",
    ) as HTMLButtonElement;
    const slides = wrapper.querySelectorAll(".carousel-slide");

    if (container && prevButton && nextButton && slides.length > 0) {
      let currentIndex = 0;
      const totalSlides = slides.length;

      function updateCarousel() {
        container.style.transform = `translateX(-${currentIndex * 100}%)`;
        updateButtons();
      }

      function updateButtons() {
        prevButton.disabled = currentIndex === 0;
        nextButton.disabled = currentIndex === totalSlides - 1;
      }

      prevButton.addEventListener("click", () => {
        if (currentIndex > 0) {
          currentIndex--;
          updateCarousel();
        }
      });

      nextButton.addEventListener("click", () => {
        if (currentIndex < totalSlides - 1) {
          currentIndex++;
          updateCarousel();
        }
      });

      updateButtons();
    }
  }

  // Initialize all carousels on the page
  document.querySelectorAll(".carousel-wrapper").forEach(initCarousel);
</script>
